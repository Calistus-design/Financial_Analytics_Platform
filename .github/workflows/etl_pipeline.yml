name: Scheduled ETL Pipeline

on:
  # Trigger the workflow on a schedule (runs at 02:00 UTC every day)
  schedule:
    - cron: '0 2 * * *'
  # Also allow running this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  run-etl:
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11" # We can use a single, stable version for this

    - name: Install GTK dependencies for WeasyPrint
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-0

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest black # Install dev dependencies just in case

    - name: Run the ETL Pipeline
      # We must provide the API key as a secret to the environment
      env:
        ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
      run: |
        python -m pipeline.main

    - name: Commit the updated report
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add reports/
        # The following command will only commit if there are changes
        git commit -m "docs(reports): Update daily summary report" || echo "No changes to commit"
        git push